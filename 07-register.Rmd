# Register-Based Survival Data Models

During the last couple of decades, huge data bases with poulation data have 
popped up almost everywhere. They are great sources of information in demographic 
and statistical research, but their sizes creates challenges for the statistical 
tools we traditionally use in the demographic analyses.

We distinguish between data sources with individual content and sources with 
tabular data. In both cases, however, we will end up analyzing tables, so we 
start by describing methods for analyzing tables.

## Tabular data

National statistical agencies produce statistics describing the population year 
by year, in terms of population size by age and sex, number of births by mother's
age and sex of the newborn, number of deaths by age and sex, and so on. In the
package **eha**, there are two data sets taken from [Statistics Sweden](https://scb.se),
`swepop` and `swedeaths`.

The content of `swepop` looks like this (first six rows out of 10504 rows in total):

```{r swepop7, echo = FALSE, message = FALSE}
library(eha)
sw <- swepop
sw$id <- NULL
rownames(sw) <- 1:NROW(sw)
head(sw)
```
It contains the average Swedish population size by year, age, and sex, where age 
is grouped into one-year classes, but the highest age class, labelled 100, is in fact 
"ages 100 and above". The original table gives the population sizes at the end of each year,
but here we have calculated an average size over the year in question by taking the mean
of the actual value and the corresponding value from the previous year. The population size 
can in this way be used as "total time at risk" or *exposure*. 

The content of `swedeaths` is (first six rows):

```{r swedeaths7, echo = FALSE}
deaths <- swedeaths
deaths$id <- NULL
rownames(deaths) <- 1:NROW(deaths)
head(deaths)
```

The `(age, sex, year)` columns in the two data frames are identical, so we can 
create a suitable data frame for analysis simply by putting `swedeaths$deaths`
into the data frame `swepop` and rename it to `sw`. The first rows of `sw` are

```{r sw7}
sw$deaths <- deaths$deaths
head(sw)
```

The response variable in our analysis is two-dimensional: `(deaths, pop)`, 
which is on an "occurrence/exposure" form, suitable for an analysis with the 
function `tpchreg`. The result is a *proportional hazards* analysis with 
the assumption of a piecewise constant baseline hazard function:

```{r tpchtab7}
system.time(fit <- tpchreg(oe(deaths, pop) ~ sex + I(year - 1995), 
               time = age, last = 101, data = sw))
sf <- summary(fit)
sf
```

Note several things here:

1.   The fitting procedure is wrapped in a call to the function `system.time`. 
This results in the first report headed "user  system  elapsed", gives the time
in seconds for the whole operation ("elapsed"), split up by "user" (the time spent
with our call) and "system" (time spent by the operating system, for instance 
reading, writing and organizing the user operation). The interesting value for us 
is that the total elapsed time was around six tenth of a second.


2.   The response is `oe(deaths. pop)` where `oe`is short for "occurrence/exposure".

3.   All covariates need a *reference value*. For factors with the default coding,
the reference category is given, but for continuous covariates we need to specify
it, if we are not satisfied with the default value *zero*. In the case with the 
covariate `year`, we are certainly *not* satisfied with zero as reference point, 
but we choose a suitable value in the range of the observed values. This is done in
practice by *subtracting* the reference value from the corresponding variable, 
`year - 1995` in our case. In the output above, this will only affect the value
of *Restricted mean survival*, which is calculated for a "reference individual",
in this case *a woman living her life during the year 1995*. There are not many such 
women, of course, what we are doing here is comparing periods, not cohorts.

4.   Note the argument `last = 101`. Since we are fitting a survival distribution
that is unbounded in time, we should specify the range for our data. The lower 
limit is given by `min(age)` (the argument `time`), but there is no natural upper limit.
The choice of the value for `last` do not affect parameter estimates and general 
conclusions, it only affects plots in the right tail (slightly). 

The graph of the baseline hazard function ("age-specific mortality") is shown in 
Figure \@ref(fig:base7).

```{r base7, fig.cap = "Baseline hazard function, women 1995. Model based.", echo = FALSE}
plot(fit, fn = "haz", main = "", xlab = "Age", ylab = "Mortality", col = "red",
     axes = FALSE)
axis(1)
axis(2, las = 1)
box()
abline(h = 0)
abline(v = sf$rmean, lty = 3)
text(78, 0.4, "Expected life at birth (81.1)", srt = 90, cex = 0.8)
```

Apart from the first year of life, mortality seems to be practically zero the first
forty years of life, and then exponentially increasing with age.

This is simple enough, but some questions remain unanswered. First, the model 
assumes proportional hazards, implying for instance that male mortality is around 
50 percent higher than female in all ages. It is fairly simple to organize a 
formal test of the proportionality assumption, but it is close to meaningless, 
because of the huge amount of data (almost five million deaths, "all" null
hypotheses will be rejected). A better 
alternative is to do it graphically by *stratifying* on `sex`.

```{r base27, fig.cap = "Baseline hazard function, women and men 1995.", echo = FALSE}
fit2 <- tpchreg(oe(deaths, pop) ~ strata(sex) + I(year - 1995), 
               time = age, last = 101, data = sw)
sf2 <- summary(fit2)
plot(fit2, fn = "haz", main = "", xlab = "Age", ylab = "Mortality", 
     col = c("red", "blue"))
abline(h = 0)
abline(v = sf2$rmean, lty = 3, col = c("red", "blue"))
```

Due to the extremely low mortality in early ages, Figure \@ref(fig:base27) is 
quite non-informative. We try the same plot on a log scale, see Figure \@ref(fig:base37).

```{r base37, fig.cap = "Baseline hazard function, women and men 1995. Log scale.", echo = FALSE}
plot(fit2, fn = "haz", main = "", xlab = "Age", ylab = "Log mortality", 
     col = c("red", "blue"), log = "y")
```

The female advantage is largest in early adulthood, after which it slowly decreases.
An even clearier picture is shown in Figure \@ref(fig:base47), where the ratio of 
male vs. female mortality is plotted.

```{r base47, fig.cap = "Baseline hazard functions, women and men 1995. Log scale.", echo = FALSE}
x <- seq(0, 100)
y <- fit2$hazards[2, ] / fit2$hazards[1, ]
plot(x, y, main = "Men vs. women", xlab = "Age", ylab = "Hazard ratio", 
     col = c("blue"), type = "l", ylim = c(1, 3))
abline(h = 1)
```

This graph gives the clearest picture of the relative differences in mortality 
over the life span. Here we see, somewhat unexpectedly, that the drop in the ratio 
is broken around  age 50, and the continues after age 70. This is not clearly 
visible in the earlier figures. A possible explanation is that the age interval
20-50 approximately coincides with women's fertility period, that is, during
this period, the mortality advantage decreases more than pure age motivates. 

Finally, this pattern may change over the time period 1968-2019. We split the 
data by year into quarters in order to check this.

```{r quarters7, fig.cap = "Baseline hazard functions, men and women by time period.", echo = FALSE}
oldpar <- par(mfrow = c(2, 2))
start <- 1968
for (i in 1:4){
    slut <- start + 12
    swx <- sw[sw$year %in% start:slut, ]
    fit2 <- tpchreg(oe(deaths, pop) ~ strata(sex) + I(year - start + 7), 
               time = age, last = 101, data = swx)
    y <- fit2$hazards[2, ] / fit2$hazards[1, ]
    plot(x, y, main = paste("Men vs. women", start, "-", slut), xlab = "Age", ylab = "Hazard ratio", 
         col = c("blue"), type = "l", ylim = c(1, 3))
    abline(h = 1)
    start <- slut + 1
}
par(oldpar)
```

The rise after age 50 seems to vanish with time, according to Figure \@ref(fig:quarters7).